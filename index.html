<!DOCTYPE html>

<html>
    <head>
        <meta charset = "utf-8">
        <title>bubble</title>
        <style type = "text/css">
            html,
            body {
            width: 100%;
            height: 100%;
            margin: 0;
            padding: 0;
            }
            #root {
            margin: 20px;
            }
        </style>

        <script src="https://cdnjs.cloudflare.com/ajax/libs/d3/3.5.5/d3.min.js"></script>
        <script>
            function start(){
             
                d3.csv("data1.csv", function(data) {
                    var nodes = data;
                    var color = d3.scale.linear().domain([2,12]).range(["#090","#f00"]);
                    var color2 = d3.scale.category20();

                    for(var i = 0;i<nodes.length;i++){
                        nodes[i].r = 30;
                        nodes[i].idx = i;
                        
                    }
                    
                    var node_drag = d3.behavior.drag()
                        .on("dragstart", dragstart)
                        .on("drag", dragmove)
                        .on("dragend", dragend);
                    
                    

                    function dragstart(d, i) {
                        
                    }

                    function dragmove(d, i) {
                        force.stop() // stops the force auto positioning before you start dragging
                        d.px += d3.event.dx;
                        d.py += d3.event.dy;
                        d.x += d3.event.dx;
                        d.y += d3.event.dy; 
                        d.fixed = true; // of course set the node to fixed so the force doesn't include the node in its auto positioning stuff
                        tick(); // this is the key to make it work together with updating both px,py,x,y on d !
                        force.resume();
                    }

                    function dragend(d, i) {
                        d.fixed = false;
                        tick();
                        force.resume();
                        
                    }
                    
                    function clicked(d, i){
                        
                        if (d3.event.defaultPrevented) return; // dragged

                        d3.select(this).transition()
                        //.delay(200)             // 延後漸變動畫的開始時間
                        .duration(400)         // 漸變動畫持續時間
                        .ease("bounce")         // 漸變動化效果
                        .attr("fill", "black")
                        .attr("r", 0)
                        .remove();
                        
                        
                        for(var j = 0; j < nodes.length; j++){
                            if(nodes[j].company == d.company){
                                nodes.splice(j,1);
                            }
                        }
                        d.company = "";
                        name.text(function(it){ return it.company});
                        
                        
                    }

                    var circles = d3.select("svg").selectAll("circle").data(nodes).enter().append("circle").call(node_drag).on("click",clicked);


                    function tick() { // tick 會不斷的被呼叫
                        
                        circles.attr({
                        cx: function(it) { return it.x; },  // it.x 由 Force Layout 提供
                        cy: function(it) { return it.y; },  // it.y 由 Force Layout 提供
                        r: function(it) { return it.r; },
                        idx: function(it) { return it.idx; },
                        fill: function(it) { return color2(it.idx);} 
                        });
                        name.attr({
                            x: function(it){ return it.x;},
                            y: function(it){ return it.y+5;},
                        })
                        

                    }
                    var force = d3.layout.force() // 建立 Layout
                        .nodes(nodes)               // 綁定資料
                        .size([800,600])            // 設定範圍
                        .distance(500)
                        .gravity(0.1)
                        .charge(-200)
                        .on("tick", tick)           // 設定 tick 函式
                        .start();                   // 啟動！

                    var name = d3.select("svg").selectAll("text").data(nodes).enter()
                    .append("text")
                    .attr({
                        x: function(it) { return it.x; },
                        y: function(it) { return it.y; },
                        idx: function(it){ return it.idx},
                        "text-anchor": "middle",                    // 文字水平置中
                    }).text(function(it) { return it.company; }); // 設定文字為國名

                        

                });
                
            }
            
            
            window.addEventListener("load", start, false);
        </script>
    </head>

    <body>
        

       
        <div id="root">
            <svg width="100%" height="600px" viewBox="0 0 800 600" preserveAspectRatio="xMidYMid"></svg>
        </div>
        
        
    </body>
</html>



